<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaguya Boss Fight</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #1a1a2e; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        canvas { border: 2px solid #6a0572; background-color: #0d0d1e; display: block; image-rendering: pixelated; }
        #loading-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Courier New', Courier, monospace; 
            font-size: 2em;
            flex-direction: column;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        LOADING ASSETS...<br>
        <span style="font-size: 0.5em; color: gray;">If stuck, check file names or console (F12).</span>
    </div>
    <canvas id="gameCanvas" width="600" height="700"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const loadingScreen = document.getElementById('loading-screen');

        const GAME_WIDTH = canvas.width;
        const GAME_HEIGHT = canvas.height;
        const PLAYER_SPEED = 4.5;
        const PLAYER_FOCUS_SPEED = 2;
        const PLAYER_HP = 5;
        const KAGUYA_HP = 500;

        let player = {
            x: GAME_WIDTH / 2, y: GAME_HEIGHT - 100,
            width: 32, height: 32, hitboxRadius: 3,
            dx: 0, dy: 0,
            bullets: [], fireCooldown: 0,
            hp: PLAYER_HP, invincible: 0
        };

        let kaguya = {
            x: GAME_WIDTH / 2, y: 120,
            width: 90, height: 90,
            hp: KAGUYA_HP, maxHp: KAGUYA_HP,
            state: 'idle',
            damageTimer: 0,
            attackTimer: 0,
            teleportTimer: 0,
            bullets: [],
            angle: 0
        };

        let gamePaused = false;
        let gameOver = false;
        let gameWon = false;
        let frameCount = 0;

        const assets = {};
        const imagesToLoad = [
            { name: 'kaguya_idle', url: 'kaguya_idle.png' },
            { name: 'kaguya_damage', url: 'kaguya_damage.png' },
            { name: 'kaguya_dead', url: 'kaguya_dead.png' },
            { name: 'kaguya_teleport', url: 'kaguya_walk.png' } 
        ];
        let loadedImages = 0;
        let gameStarted = false;

        function tryStartGame() {
            if (!gameStarted) {
                gameStarted = true;
                loadingScreen.style.display = 'none';
                gameLoop();
            }
        }

        imagesToLoad.forEach(img => {
            const image = new Image();
            image.src = img.url;
            image.onload = () => {
                loadedImages++;
                assets[img.name] = image;
                if (loadedImages === imagesToLoad.length) tryStartGame();
            };
            image.onerror = () => {
                loadedImages++;
                if (loadedImages === imagesToLoad.length) tryStartGame();
            };
        });

        setTimeout(() => { if (!gameStarted) tryStartGame(); }, 2000);

        const keys = {};
        window.addEventListener('keydown', e => {
            keys[e.key] = true;
            if (e.key === 'p' || e.key === 'P') gamePaused = !gamePaused;
        });
        window.addEventListener('keyup', e => keys[e.key] = false);

        function update() {
            if (gamePaused || gameOver || gameWon) return;
            frameCount++;

            let speed = keys['Shift'] ? PLAYER_FOCUS_SPEED : PLAYER_SPEED;
            player.dx = 0; player.dy = 0;
            if (keys['ArrowLeft'] || keys['a']) player.dx = -speed;
            if (keys['ArrowRight'] || keys['d']) player.dx = speed;
            if (keys['ArrowUp'] || keys['w']) player.dy = -speed;
            if (keys['ArrowDown'] || keys['s']) player.dy = speed;
            
            player.x = Math.max(10, Math.min(GAME_WIDTH - 10, player.x + player.dx));
            player.y = Math.max(10, Math.min(GAME_HEIGHT - 10, player.y + player.dy));

            if ((keys['z'] || keys['Z']) && player.fireCooldown <= 0) {
                player.bullets.push({x: player.x - 10, y: player.y, speed: 12, angle: -0.1});
                player.bullets.push({x: player.x, y: player.y - 5, speed: 12, angle: 0});
                player.bullets.push({x: player.x + 10, y: player.y, speed: 12, angle: 0.1});
                player.fireCooldown = 6;
            }
            if (player.fireCooldown > 0) player.fireCooldown--;
            if (player.invincible > 0) player.invincible--;

            for (let i = player.bullets.length - 1; i >= 0; i--) {
                let b = player.bullets[i];
                b.x += Math.sin(b.angle) * b.speed;
                b.y -= Math.cos(b.angle) * b.speed;
                if (b.y < -50) player.bullets.splice(i, 1);
            }

            if (kaguya.hp > 0) {
                if (kaguya.damageTimer > 0) kaguya.damageTimer--;
                kaguya.teleportTimer++;
                if (kaguya.teleportTimer > 300) {
                    kaguya.state = 'teleporting';
                    if (kaguya.teleportTimer > 360) {
                        kaguya.x = 100 + Math.random() * (GAME_WIDTH - 200);
                        kaguya.y = 50 + Math.random() * 100;
                        kaguya.state = 'idle';
                        kaguya.teleportTimer = 0;
                        for(let i=0; i<36; i++) {
                             kaguya.bullets.push({x: kaguya.x, y: kaguya.y, speed: 4, angle: (Math.PI * 2 / 36) * i, color: '#FF00FF', radius: 6});
                        }
                    }
                }
                if (kaguya.state !== 'teleporting') {
                    kaguya.angle += 0.04;
                    if (frameCount % 4 === 0) {
                        kaguya.bullets.push({x: kaguya.x, y: kaguya.y, speed: 3, angle: kaguya.angle, color: 'cyan', radius: 4});
                        kaguya.bullets.push({x: kaguya.x, y: kaguya.y, speed: 3, angle: kaguya.angle + Math.PI, color: 'white', radius: 4});
                    }
                }
            } else {
                kaguya.state = 'dead';
                if (!gameWon) setTimeout(() => gameWon = true, 100);
            }

            for (let i = kaguya.bullets.length - 1; i >= 0; i--) {
                let b = kaguya.bullets[i];
                b.x += Math.cos(b.angle) * b.speed;
                b.y += Math.sin(b.angle) * b.speed;
                if (b.x < -50 || b.x > GAME_WIDTH + 50 || b.y < -50 || b.y > GAME_HEIGHT + 50) kaguya.bullets.splice(i, 1);
            }

            checkCollisions();
        }

        function checkCollisions() {
            if (player.invincible <= 0 && !gameWon && !gameOver) {
                for (let b of kaguya.bullets) {
                    let dist = Math.sqrt((player.x - b.x)**2 + (player.y - b.y)**2);
                    if (dist < player.hitboxRadius + b.radius) {
                        player.hp--; player.invincible = 90; player.bullets = [];
                        if (player.hp <= 0) gameOver = true;
                    }
                }
            }
            if (kaguya.state !== 'teleporting' && kaguya.state !== 'dead') {
                for (let i = player.bullets.length - 1; i >= 0; i--) {
                    let b = player.bullets[i];
                    if (b.x > kaguya.x - 40 && b.x < kaguya.x + 40 && b.y > kaguya.y - 50 && b.y < kaguya.y + 50) {
                        kaguya.hp--; kaguya.damageTimer = 5; player.bullets.splice(i, 1);
                    }
                }
            }
        }

        function draw() {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

            if (kaguya.state === 'dead') {
                if (assets.kaguya_dead) ctx.drawImage(assets.kaguya_dead, kaguya.x - 64, kaguya.y - 64, 128, 128);
            } else if (kaguya.state === 'teleporting') {
                ctx.globalAlpha = 0.6;
                if (assets.kaguya_teleport) ctx.drawImage(assets.kaguya_teleport, kaguya.x - 45, kaguya.y - 45, 90, 90);
                ctx.globalAlpha = 1.0;
            } else {
                let sprite = (kaguya.damageTimer > 0 && assets.kaguya_damage) ? assets.kaguya_damage : assets.kaguya_idle;
                if (sprite) ctx.drawImage(sprite, kaguya.x - 45, kaguya.y - 45, 90, 90);
            }

            kaguya.bullets.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, b.radius, 0, Math.PI*2); ctx.fillStyle = b.color; ctx.fill(); });

            if (!gameOver) {
                ctx.fillStyle = player.invincible % 10 > 5 ? 'transparent' : 'red';
                ctx.beginPath(); ctx.arc(player.x, player.y, 5, 0, Math.PI*2); ctx.fill(); 
                if (keys['Shift']) { ctx.strokeStyle = 'white'; ctx.beginPath(); ctx.arc(player.x, player.y, 20, 0, Math.PI*2); ctx.stroke(); }
            }

            ctx.fillStyle = '#ffff00';
            player.bullets.forEach(b => ctx.fillRect(b.x - 2, b.y - 8, 4, 16));

            ctx.fillStyle = 'black'; ctx.fillRect(20, 20, GAME_WIDTH - 40, 10);
            ctx.fillStyle = 'red'; ctx.fillRect(20, 20, (GAME_WIDTH - 40) * (kaguya.hp / KAGUYA_HP), 10);
            ctx.strokeStyle = 'white'; ctx.strokeRect(20, 20, GAME_WIDTH - 40, 10);

            ctx.fillStyle = 'white'; ctx.font = '16px Arial'; ctx.textAlign = 'left';
            ctx.fillText(`LIVES: ${player.hp}`, 20, GAME_HEIGHT - 20);

            if (gamePaused) {
                ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(0,0,GAME_WIDTH, GAME_HEIGHT);
                ctx.fillStyle = 'white'; ctx.font = '40px Arial'; ctx.textAlign = 'center';
                ctx.fillText("PAUSED", GAME_WIDTH/2, GAME_HEIGHT/2);
            }
            if (gameWon) {
                ctx.fillStyle = 'gold'; ctx.font = '40px Arial'; ctx.textAlign = 'center';
                ctx.fillText("KAGUYA DEFEATED!", GAME_WIDTH/2, GAME_HEIGHT/2);
            }
            if (gameOver) {
                ctx.fillStyle = 'red'; ctx.font = '40px Arial'; ctx.textAlign = 'center';
                ctx.fillText("GAME OVER", GAME_WIDTH/2, GAME_HEIGHT/2);
            }
        }

        function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }
    </script>
</body>
</html>
