<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lunatic Love Build 0.1.19</title>
    <link rel="icon" type="image/png" href="https://imgur.com/yWGCBpw.png">
    <style>
        body { margin: 0; background: #000; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; color: #fff; font-family: 'Courier New', monospace; }
        #game-container { display: flex; align-items: center; gap: 30px; }
        #sidebar { width: 140px; background: rgba(20, 0, 40, 0.8); border: 2px solid #8a2be2; padding: 12px; display: flex; flex-direction: column; gap: 8px; }
        canvas { border: 3px solid #4b0082; background: #050510; box-shadow: 0 0 30px #4b0082; }
        .key-box { border: 1px solid #fff; padding: 2px; text-align: center; background: #333; font-weight: bold; font-size: 0.85em; }
        .key-desc { font-size: 0.7em; color: #bbb; text-align: center; margin-bottom: 3px; }
        .stat-box { border-left: 3px solid #ff00ff; padding-left: 8px; margin-bottom: 5px; }
        .stat-label { font-size: 0.65em; color: #aaa; text-transform: uppercase; }
        .stat-value { font-size: 1em; font-weight: bold; }
        .ui-overlay { position: absolute; width: 600px; height: 700px; display: flex; flex-direction: column; align-items: center; background: rgba(0,0,0,0.9); z-index: 20; padding-top: 40px; }
        .logo-img { width: 380px; margin-bottom: 10px; }
        .dev-container { display: flex; flex-direction: column; align-items: center; margin-bottom: 30px; }
        .dev-text { font-size: 0.7em; color: #aaa; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .dev-img { width: 160px; }
        .menu-btn { background: #4b0082; border: 2px solid #fff; color: white; padding: 10px; margin: 5px; cursor: pointer; font-family: 'Courier New', monospace; width: 220px; }
        .active-diff { background: #fff !important; color: #000 !important; font-weight: bold; }
        #dialogue-box { position: absolute; bottom: 40px; width: 520px; height: 120px; background: rgba(0, 0, 50, 0.95); border: 3px solid #fff; padding: 10px; display: none; z-index: 30; align-items: center; left: 40px; }
        #face-container { width: 100px; height: 100px; border: 2px solid #aaa; margin-right: 15px; flex-shrink: 0; overflow: hidden; background: #000; }
        #face-img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="sidebar">
            <div style="text-align: center; color: #ff00ff; font-weight: bold; border-bottom: 1px solid #ff00ff; padding-bottom: 3px; font-size: 0.9em;">STATUS</div>
            <div class="stat-box"><div class="stat-label">Lives</div><div id="ui-lives" class="stat-value">0</div></div>
            <div class="stat-box"><div class="stat-label">Bombs</div><div id="ui-bombs" class="stat-value">0</div></div>
            <div style="text-align: center; color: #00ffff; font-weight: bold; border-bottom: 1px solid #00ffff; padding-bottom: 3px; margin-top: 10px; font-size: 0.9em;">KEYS</div>
            <div><div class="key-box">↑↓←→</div><div class="key-desc">Move</div></div>
            <div><div class="key-box">Z</div><div class="key-desc">Shoot</div></div>
            <div><div class="key-box">X</div><div class="key-desc">Bomb</div></div>
            <div><div class="key-box">SHIFT</div><div class="key-desc">Focus</div></div>
        </div>

        <div style="position: relative;">
            <div id="main-menu" class="ui-overlay">
                <img src="https://imgur.com/yWGCBpw.png" class="logo-img">
                <div class="dev-container">
                    <div class="dev-text">Created and developed by</div>
                    <img src="https://imgur.com/btg3Zph.png" class="dev-img">
                </div>
                <button class="menu-btn" onclick="startGame()">START GAME</button>
                <button class="menu-btn" onclick="toggleOptions(true)">DIFFICULTY</button>
                <div id="current-diff-display" style="margin-top:10px; font-size:0.8em; color:#aaa;">Difficulty: Medium</div>
            </div>

            <div id="options-menu" class="ui-overlay" style="display:none;">
                <h2 style="color: #ff00ff;">DIFFICULTY</h2>
                <button class="menu-btn diff-opt" onclick="setDiff(0)">VERY EASY</button>
                <button class="menu-btn diff-opt" onclick="setDiff(1)">EASY</button>
                <button class="menu-btn diff-opt active-diff" onclick="setDiff(2)">MEDIUM</button>
                <button class="menu-btn diff-opt" onclick="setDiff(3)">HARD</button>
                <button class="menu-btn diff-opt" onclick="setDiff(4)">VERY HARD</button>
                <button class="menu-btn diff-opt" onclick="setDiff(5)">LUNATIC</button>
                <button class="menu-btn" style="margin-top:20px; background:#444;" onclick="toggleOptions(false)">BACK</button>
            </div>

            <div id="dialogue-box">
                <div id="face-container"><img id="face-img" src=""></div>
                <div id="text-container">
                    <div id="char-name" style="font-weight:bold; border-bottom:1px solid #555">NAME</div>
                    <div id="char-text">TEXT</div>
                </div>
            </div>
            <canvas id="gameCanvas" width="600" height="700"></canvas>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const k_imgs = {};
        const k_urls = {
            idle: 'https://imgur.com/eJtPITs.png', defend: 'https://imgur.com/8VYfVnQ.png',
            hit: 'https://imgur.com/I5eFRGd.png', attack: 'https://imgur.com/Ty6yJaN.png', push: 'https://imgur.com/R1PKVO3.png'
        };
        Object.keys(k_urls).forEach(key => { k_imgs[key] = new Image(); k_imgs[key].src = k_urls[key]; });
        const m_back = new Image(); m_back.src = 'https://imgur.com/s8t8Lml.png';
        const portraits = {
            k_normal: 'https://imgur.com/fheByI4.png', k_sad: 'https://imgur.com/pHJtwPT.gif', 
            m_normal: 'https://imgur.com/OLqSOVo.png', k_win1: 'https://imgur.com/4NDoDX3.png',
            k_win2: 'https://imgur.com/XALOmdx.png'
        };

        const introDialogue = [
            { name: "Kaguya", text: "You really don't know when to give up, do you? This eternity is far beyond your reach.", face: portraits.k_normal },
            { name: "Miyuki Shirogane", text: "I told you... I would come for you no matter where you are.", face: portraits.m_normal },
            { name: "Kaguya", text: "How bold. Then show me that resolve. Prove that your heart can survive the moonlight!", face: portraits.k_normal }
        ];

        const winDialogue = [
            { name: "Kaguya", text: "Ugh... my barrier... how could you break through it?", face: portraits.k_win1 },
            { name: "Miyuki Shirogane", text: "I already told you, Kaguya. My feelings for you are stronger than any curse or eternity.", face: portraits.m_normal },
            { name: "Kaguya", text: "L-L-Love??? Don't say such embarrassing things so casually!", face: portraits.k_win2 },
            { name: "Miyuki Shirogane", text: "I'm not joking. Now, let's go home together.", face: portraits.m_normal }
        ];

        let gameState = 'MENU', diagIdx = 0, frame = 0, deathTimer = 0, fadeAlpha = 0;
        let keys = {}, player, boss, difficulty = 2;

        const diffSettings = [
            { name: "Very Easy", bSpd: 0.6, bFreq: 30, bCount: 3, pDmg: 15 },
            { name: "Easy",      bSpd: 0.8, bFreq: 20, bCount: 4, pDmg: 6 },
            { name: "Medium",    bSpd: 1.2, bFreq: 12, bCount: 6, pDmg: 3 },
            { name: "Hard",      bSpd: 1.6, bFreq: 9,  bCount: 10, pDmg: 1.8 },
            { name: "Very Hard", bSpd: 2.2, bFreq: 6,  bCount: 16, pDmg: 1.2 },
            { name: "Lunatic",   bSpd: 3.2, bFreq: 4,  bCount: 24, pDmg: 0.8 } // Touhou-like density
        ];

        function toggleOptions(show) {
            document.getElementById('main-menu').style.display = show ? 'none' : 'flex';
            document.getElementById('options-menu').style.display = show ? 'flex' : 'none';
        }

        function setDiff(val) {
            difficulty = val;
            document.querySelectorAll('.diff-opt').forEach((btn, i) => btn.classList.toggle('active-diff', i === val));
            document.getElementById('current-diff-display').innerText = "Difficulty: " + diffSettings[val].name;
        }

        function resetToMenu() {
            gameState = 'MENU'; player = null; boss = null;
            frame = 0; deathTimer = 0; fadeAlpha = 0;
            document.getElementById('main-menu').style.display = 'flex';
            document.getElementById('dialogue-box').style.display = 'none';
        }

        function startGame() {
            player = { x: 300, y: 600, hp: 5, maxHp: 5, bombs: 3, bullets: [], inv: 0 };
            boss = { x: 300, y: 150, hp: 1000, maxHp: 1000, bullets: [], angle: 0, state: 'idle', hitTimer: 0 };
            document.getElementById('main-menu').style.display = 'none';
            gameState = 'DIAL'; diagIdx = 0;
            updateSidebar(); updateDialogue(introDialogue[0]);
        }

        function updateSidebar() {
            if (!player) return;
            document.getElementById('ui-lives').innerText = player.hp;
            document.getElementById('ui-bombs').innerText = player.bombs;
        }

        window.onkeydown = (e) => {
            const k = e.key.toLowerCase(); keys[k] = true;
            if (k === 'z') {
                if (gameState === 'DIAL') {
                    diagIdx++;
                    if (diagIdx >= introDialogue.length) { gameState = 'FIGHT'; document.getElementById('dialogue-box').style.display = 'none'; }
                    else updateDialogue(introDialogue[diagIdx]);
                } else if (gameState === 'WIN_SCENE') {
                    diagIdx++;
                    if (diagIdx >= winDialogue.length) resetToMenu();
                    else updateDialogue(winDialogue[diagIdx]);
                } else if (gameState === 'GAMEOVER') resetToMenu();
            }
            if (k === 'x' && gameState === 'FIGHT' && player.bombs > 0) { player.bombs--; player.inv = 120; boss.bullets = []; updateSidebar(); }
        };
        window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;

        function updateDialogue(d) {
            document.getElementById('dialogue-box').style.display = 'flex';
            document.getElementById('char-name').innerText = d.name;
            document.getElementById('char-text').innerText = d.text;
            document.getElementById('face-img').src = d.face;
            document.getElementById('char-name').style.color = d.name.includes("Kaguya") ? "#ff00ff" : "#00ffff";
        }

        function update() {
            if (gameState === 'FIGHT') {
                frame++; if (player.inv > 0) player.inv--;
                let cfg = diffSettings[difficulty];
                let spd = keys['shift'] ? 2.5 : 5.5;
                if (keys['arrowleft'] || keys['a']) player.x -= spd;
                if (keys['arrowright'] || keys['d']) player.x += spd;
                if (keys['arrowup'] || keys['w']) player.y -= spd;
                if (keys['arrowdown'] || keys['s']) player.y += spd;
                player.x = Math.max(30, Math.min(570, player.x));
                player.y = Math.max(30, Math.min(670, player.y));

                if (keys['z'] && frame % 5 === 0) player.bullets.push({x: player.x, y: player.y - 20});
                player.bullets.forEach((b, i) => { b.y -= 14; if(b.y < -20) player.bullets.splice(i, 1); });

                let dist = Math.hypot(player.x - boss.x, player.y - boss.y);
                if (boss.hitTimer > 0) { boss.state = 'hit'; boss.hitTimer--; }
                else if (dist < 80) boss.state = 'push';
                else if (dist < 180) boss.state = 'defend';
                else if (frame % 30 < 15) boss.state = 'attack';
                else boss.state = 'idle';

                boss.angle += 0.04 * cfg.bSpd;
                if (frame % cfg.bFreq === 0) {
                    for(let i=0; i < cfg.bCount; i++) {
                        let a = boss.angle + (Math.PI*2/cfg.bCount * i);
                        boss.bullets.push({x: boss.x, y: boss.y, vx: Math.cos(a)*3*cfg.bSpd, vy: Math.sin(a)*3*cfg.bSpd});
                    }
                }

                boss.bullets.forEach((b, i) => {
                    b.x += b.vx; b.y += b.vy;
                    if (player.inv <= 0 && Math.hypot(b.x - player.x, b.y - player.y) < 8) {
                        player.hp--; player.inv = 60; updateSidebar();
                        if (player.hp <= 0) { gameState = 'DYING'; deathTimer = 60; }
                    }
                    if(b.x < -50 || b.x > 650 || b.y < -50 || b.y > 750) boss.bullets.splice(i,1);
                });

                player.bullets.forEach((b, i) => {
                    if (Math.hypot(b.x - boss.x, b.y - boss.y) < 50) {
                        boss.hp -= cfg.pDmg; boss.hitTimer = 5; player.bullets.splice(i, 1);
                        if (boss.hp <= 0) { gameState = 'WIN_SCENE'; boss.state = 'idle'; diagIdx = 0; updateDialogue(winDialogue[0]); }
                    }
                });
            }
            if (gameState === 'DYING') { deathTimer--; fadeAlpha = Math.min(1, fadeAlpha + 0.02); if (deathTimer <= 0) { gameState = 'GAMEOVER'; updateDialogue({ name: "Kaguya", text: "I thought you could really make it...", face: portraits.k_sad }); } }
        }

        function draw() {
            ctx.fillStyle = '#050510'; ctx.fillRect(0, 0, 600, 700);
            if (gameState !== 'MENU') {
                let img = k_imgs[boss.state] || k_imgs.idle;
                ctx.drawImage(img, boss.x-45, boss.y-55, 90, 110);
                if (gameState === 'FIGHT' || gameState === 'DYING' || gameState === 'WIN_SCENE') {
                    if (gameState !== 'WIN_SCENE' && player.inv % 4 < 2) {
                        ctx.drawImage(m_back, player.x-30, player.y-40, 60, 80);
                        ctx.fillStyle = '#333'; ctx.fillRect(player.x-20, player.y-55, 40, 5);
                        ctx.fillStyle = '#0f0'; ctx.fillRect(player.x-20, player.y-55, 40 * (player.hp/player.maxHp), 5);
                    }
                    if (gameState === 'FIGHT') boss.bullets.forEach(b => { ctx.fillStyle = '#ff00ff'; ctx.beginPath(); ctx.arc(b.x, b.y, 6, 0, Math.PI*2); ctx.fill(); });
                    player.bullets.forEach(b => { ctx.fillStyle = '#fff'; ctx.fillRect(b.x-2, b.y, 4, 15); });
                    ctx.fillStyle = 'red'; ctx.fillRect(50, 20, 500 * (Math.max(0, boss.hp)/boss.maxHp), 10);
                }
            }
            if (fadeAlpha > 0) { ctx.fillStyle = `rgba(0,0,0,${fadeAlpha})`; ctx.fillRect(0, 0, 600, 700); }
            requestAnimationFrame(() => { update(); draw(); });
        }
        draw();
    </script>
</body>
</html>
