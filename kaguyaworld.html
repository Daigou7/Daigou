<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Kaguya World</title>
    <link rel="icon" type="image/png" href="https://imgur.com/fheByI4.png">
    <style>
        body { margin: 0; background: #000; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: 'Courier New', Courier, monospace; }
        canvas { background: #5c94fc; border: 4px solid #fff; image-rendering: pixelated; }
        .ui { position: absolute; top: 20px; color: white; text-align: left; width: 760px; pointer-events: none; text-shadow: 2px 2px #000; display: flex; flex-direction: column; gap: 5px; }
        .stat-row { display: flex; align-items: center; gap: 10px; font-size: 22px; font-weight: bold; }
        .icon { width: 35px; height: 35px; object-fit: contain; }
    </style>
</head>
<body>
    <div class="ui">
        <div class="stat-row">
            <img src="https://imgur.com/7H8pFGh.png" class="icon" alt="vida">
            <span id="lifeText">LIFES = 3</span>
        </div>
        <div class="stat-row">
            <span style="font-size: 30px; width: 35px; text-align: center;">üí∏</span>
            <span id="moneyText">MONEY = 0</span>
        </div>
    </div>
    <canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = 800; canvas.height = 400;

    const gravity = 0.6;
    const friction = 0.8;
    let keys = [];
    let cameraX = 0;
    let money = 0;
    let lastGeneratedX = 800;

    const imgIdle = new Image(); 
    imgIdle.src = "https://imgur.com/urbofgF.png";
    const imgJump = new Image(); 
    imgJump.src = "https://imgur.com/NW9NZBS.png";

    let player = {
        x: 100, y: 300, width: 40, height: 50, speed: 5,
        velX: 0, velY: 0, jumping: false, grounded: false,
        lives: 3, invincible: false,
        lastSafeX: 100, lastSafeY: 300
    };

    let platforms = [{ x: 0, y: 370, width: 1000, height: 30 }];
    let collectibles = [];
    let enemies = [];

    function spawnProcedural(startX, endX) {
        for (let x = startX; x < endX; x += 300) {
            let platW = 150 + Math.random() * 200;
            let platY = 150 + Math.random() * 150;
            platforms.push({ x: x, y: platY, width: platW, height: 20 });

            let chance = Math.random() * 100;
            let item = { x: x + platW/2, y: platY - 40, type: 'üí∏', value: 1 };
            
            if (chance < 0.1) { item.type = 'üíé'; item.value = 1000000; }
            else if (chance < 10) { item.type = 'üí∞'; item.value = 10000; }
            else if (chance < 50) { item.type = 'üíµ'; item.value = 100; }
            
            collectibles.push(item);

            if (Math.random() > 0.5) {
                enemies.push({
                    x: x + 20, y: platY - 30, width: 30, height: 30,
                    speed: 2, 
                    emoji: ["üê¢", "ü¶î", "ü¶Ä"][Math.floor(Math.random()*3)],
                    range: platW - 50, startX: x + 20
                });
            }
        }
    }

    spawnProcedural(1000, 3000);

    function update() {
        if (keys[38] || keys[32] || keys[87]) {
            if (!player.jumping && player.grounded) {
                player.jumping = true; player.grounded = false;
                player.velY = -player.speed * 2.5;
            }
        }
        if (keys[39] || keys[68]) { if (player.velX < player.speed) player.velX++; }
        if (keys[37] || keys[65]) { if (player.velX > -player.speed) player.velX--; }

        player.velX *= friction;
        player.velY += gravity;
        player.grounded = false;

        if (player.x + 1000 > lastGeneratedX) {
            spawnProcedural(lastGeneratedX, lastGeneratedX + 2000);
            lastGeneratedX += 2000;
        }

        cameraX = player.x - 200;
        if (cameraX < 0) cameraX = 0;

        ctx.save();
        ctx.translate(-cameraX, 0);

        ctx.fillStyle = "#8b4513";
        platforms.forEach(p => {
            ctx.fillRect(p.x, p.y, p.width, p.height);
            let dir = colCheck(player, p);
            if (dir === "b") { 
                player.grounded = true; 
                player.jumping = false;
                player.lastSafeX = p.x + 20;
                player.lastSafeY = p.y - 60;
            }
            else if (dir === "t") player.velY *= -0.5;
        });

        ctx.font = "30px Arial";
        collectibles.forEach((c, index) => {
            ctx.fillText(c.type, c.x, c.y);
            if (rectIntersect(player.x, player.y, player.width, player.height, c.x, c.y-25, 30, 30)) {
                money += c.value;
                document.getElementById("moneyText").innerText = "MONEY = " + money.toLocaleString('pt-BR');
                collectibles.splice(index, 1);
            }
        });

        enemies.forEach(en => {
            en.x += en.speed;
            if (en.x > en.startX + en.range || en.x < en.startX) en.speed *= -1;
            ctx.fillText(en.emoji, en.x, en.y + 25);
            if (rectIntersect(player.x, player.y, player.width, player.height, en.x, en.y, 30, 30)) takeDamage();
        });

        if (player.grounded) player.velY = 0;
        player.x += player.velX;
        player.y += player.velY;

        // Corre√ß√£o do Bug de Morte Instant√¢nea na Queda
        if (player.y > canvas.height + 50) { 
            takeDamage();
            player.x = player.lastSafeX;
            player.y = player.lastSafeY;
            player.velX = 0;
            player.velY = 0;
        }

        let currentImg = player.jumping ? imgJump : imgIdle;
        if (player.invincible && Math.floor(Date.now() / 100) % 2 === 0) ctx.globalAlpha = 0.5;
        ctx.drawImage(currentImg, player.x, player.y, player.width, player.height);
        ctx.globalAlpha = 1.0;
        ctx.restore();
    }

    function takeDamage() {
        if (!player.invincible) {
            player.lives--;
            document.getElementById("lifeText").innerText = "LIFES = " + player.lives;
            player.invincible = true;
            if (player.lives <= 0) {
                alert("Game Over! Total: " + money.toLocaleString('pt-BR'));
                location.reload();
            }
            setTimeout(() => player.invincible = false, 1500);
        }
    }

    function rectIntersect(x1, y1, w1, h1, x2, y2, w2, h2) {
        return x2 < x1 + w1 && x2 + w2 > x1 && y2 < y1 + h1 && y2 + h2 > y1;
    }

    function colCheck(shapeA, shapeB) {
        let vX = (shapeA.x + (shapeA.width / 2)) - (shapeB.x + (shapeB.width / 2)),
            vY = (shapeA.y + (shapeA.height / 2)) - (shapeB.y + (shapeB.height / 2)),
            hWidths = (shapeA.width / 2) + (shapeB.width / 2),
            hHeights = (shapeA.height / 2) + (shapeB.height / 2),
            colDir = null;
        if (Math.abs(vX) < hWidths && Math.abs(vY) < hHeights) {
            let oX = hWidths - Math.abs(vX), oY = hHeights - Math.abs(vY);
            if (oX >= oY) {
                if (vY > 0) { colDir = "t"; shapeA.y += oY; }
                else { colDir = "b"; shapeA.y -= oY; }
            } else {
                if (vX > 0) { colDir = "l"; shapeA.x += oX; }
                else { colDir = "r"; shapeA.x -= oX; }
            }
        }
        return colDir;
    }

    function loop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        update();
        requestAnimationFrame(loop);
    }

    window.addEventListener("keydown", (e) => keys[e.keyCode] = true);
    window.addEventListener("keyup", (e) => keys[e.keyCode] = false);
    loop();
</script>
</body>
</html>
