<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kaguya World 1.9.7</title>
    <style>
        body { margin: 0; padding: 0; background: #5c94fc; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        canvas { background: linear-gradient(to bottom, #5c94fc 0%, #92b9ff 100%); display: block; image-rendering: pixelated; }
        
        .overlay { position: absolute; width: 100%; height: 100%; background: rgba(15, 15, 25, 0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 20; }
        
        /* Header Group */
        .header-group { display: flex; flex-direction: column; align-items: center; margin-bottom: 30px; }
        .logo-main { width: 420px; filter: drop-shadow(0 0 15px rgba(72, 248, 120, 0.3)); }
        .dev-creds { display: flex; flex-direction: column; align-items: center; margin-top: -10px; opacity: 0.9; }
        .dev-creds span { font-size: 12px; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px; color: #aaa; }
        .logo-dev { height: 35px; }

        /* Modern Buttons */
        .menu-btn { 
            background: linear-gradient(135deg, #48f878 0%, #2dbd5a 100%); 
            border: none; 
            padding: 14px 40px; 
            font-size: 18px; 
            cursor: pointer; 
            margin: 8px; 
            font-weight: 700; 
            color: #05200b;
            border-radius: 50px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 15px rgba(72, 248, 120, 0.4);
            min-width: 220px;
        }
        .menu-btn:hover { 
            transform: translateY(-3px) scale(1.05); 
            box-shadow: 0 8px 25px rgba(72, 248, 120, 0.6);
            filter: brightness(1.1);
        }
        .menu-btn:active { transform: translateY(0); }

        /* Controls Box at Bottom */
        .controls-guide { 
            background: rgba(255, 255, 255, 0.05); 
            padding: 15px 25px; 
            border-radius: 15px; 
            margin-top: 30px; 
            font-size: 13px; 
            text-align: center; 
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ccc;
            backdrop-filter: blur(5px);
        }
        .controls-guide b { color: #48f878; font-size: 15px; }

        /* Panels */
        #leaderboardDisplay, #optionsPanel { display: none; background: #1a1a1a; padding: 30px; border-radius: 20px; border: 1px solid #48f878; min-width: 300px; text-align: center; }
        .rank-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #333; }

        /* In-game UI */
        .ui { position: absolute; top: 20px; left: 20px; color: white; pointer-events: none; display: none; flex-direction: column; gap: 8px; z-index: 10; }
        .bar-container { width: 180px; height: 12px; background: rgba(0,0,0,0.6); border-radius: 10px; overflow: hidden; border: 1px solid rgba(255,255,255,0.2); }
        .hp-fill { width: 100%; height: 100%; background: #ff4d4d; box-shadow: 0 0 10px #ff4d4d; }
        .stamina-fill { width: 100%; height: 100%; background: #00d4ff; box-shadow: 0 0 10px #00d4ff; }
    </style>
</head>
<body>

    <div id="menuOverlay" class="overlay">
        <div class="header-group">
            <img src="https://imgur.com/Fowormz.png" class="logo-main" alt="Kaguya World">
            <div class="dev-creds">
                <span>Created and Developed by</span>
                <img src="https://imgur.com/btg3Zph.png" class="logo-dev">
            </div>
        </div>
        
        <div id="mainButtons" style="display: flex; flex-direction: column;">
            <button class="menu-btn" onclick="startGame()">Play Game</button>
            <button class="menu-btn" onclick="showOptions()">Options</button>
            <button class="menu-btn" onclick="showLeaderboard()">Leaderboard</button>
        </div>

        <div id="optionsPanel">
            <h2 style="color: #48f878;">OPTIONS</h2>
            <div style="margin-bottom: 20px; font-size: 18px;">
                <input type="checkbox" id="noSpiders" style="transform: scale(1.5); margin-right: 10px;">
                <label for="noSpiders">NO SPIDERS</label>
            </div>
            <button class="menu-btn" onclick="hideAllPanels()">Back</button>
        </div>

        <div id="leaderboardDisplay">
            <h2 style="color: #48f878;">RANKING</h2>
            <div id="rankList"></div>
            <button class="menu-btn" onclick="hideAllPanels()" style="margin-top:20px">Back</button>
        </div>

        <div class="controls-guide">
            <b>GAME CONTROLS</b><br>
            <span style="display: block; margin-top: 5px;">
                Move: WASD / Arrows | Jump: Space/W | Dash: Shift<br>
                Defend: S | Attack: X | Pause: Enter
            </span>
        </div>
    </div>

    <div id="pauseOverlay" style="display:none; position:absolute; color:white; font-size:50px; z-index:15; text-shadow:0 0 20px #000;">PAUSED</div>

    <div class="ui" id="gameUI">
        <div style="font-size: 22px; font-weight: bold; margin-bottom: 5px;">CASH: <span id="moneyText" style="color:#48f878;">0</span></div>
        <div class="bar-container"><div id="hpFill" class="hp-fill"></div></div>
        <div class="bar-container"><div id="staminaFill" class="stamina-fill"></div></div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    let gameRunning = false, isPaused = false, noSpiders = false;

    const spr = {
        idle: new Image(), walk: new Image(), dash: new Image(),
        jump: new Image(), defend: new Image(), hurt: new Image(),
        dead: new Image(), kick: new Image()
    };
    spr.idle.src = "https://imgur.com/eJtPITs.png";
    spr.walk.src = "https://imgur.com/SQCGCDm.png";
    spr.dash.src = "https://imgur.com/LVI6uTi.png";
    spr.jump.src = "https://imgur.com/zEk3Cek.png";
    spr.defend.src = "https://imgur.com/8VYfVnQ.png";
    spr.hurt.src = "https://imgur.com/I5eFRGd.png";
    spr.dead.src = "https://imgur.com/1NDnHJe.png";
    spr.kick.src = "https://imgur.com/oSyk1P9.png";

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    function showOptions() { document.getElementById("mainButtons").style.display = "none"; document.getElementById("optionsPanel").style.display = "block"; }
    function showLeaderboard() {
        document.getElementById("mainButtons").style.display = "none";
        document.getElementById("leaderboardDisplay").style.display = "block";
        const scores = JSON.parse(localStorage.getItem('kaguya_scores')) || [];
        document.getElementById("rankList").innerHTML = scores.map((s, i) => `<div class="rank-item"><span>${i+1}. ${s.name}</span><span>$${s.score}</span></div>`).join('') || "No data.";
    }
    function hideAllPanels() {
        document.getElementById("mainButtons").style.display = "flex";
        document.getElementById("optionsPanel").style.display = "none";
        document.getElementById("leaderboardDisplay").style.display = "none";
    }

    function startGame() {
        noSpiders = document.getElementById("noSpiders").checked;
        document.getElementById("menuOverlay").style.display = "none";
        document.getElementById("gameUI").style.display = "flex";
        gameRunning = true; spawnInfinite(0, 5000); loop();
    }

    let player = { x: 100, y: 0, width: 135, height: 180, velX: 0, velY: 0, hp: 100, stamina: 100, shield: 100, grounded: false, facing: 1, state: "idle", invincible: false };
    let keys = {}, platforms = [{ x: 0, y: window.innerHeight - 200, width: 2500, height: 600 }], enemies = [], cameraX = 0, money = 0;
    let lastGeneratedX = 2500;

    function spawnInfinite(startX, range) {
        let currentX = startX;
        while (currentX < startX + range) {
            let gap = 220 + Math.random() * 280;
            currentX += gap;
            let platW = 600 + Math.random() * 800;
            let platY = window.innerHeight - (200 + Math.random() * 250);
            platforms.push({ x: currentX, y: platY, width: platW, height: 1000 });
            if (Math.random() > 0.45) {
                let pool = ["ðŸ¢", "ðŸ¦”", "ðŸ¦€", "ðŸ¦–"];
                if (!noSpiders) pool.push("ðŸ•·ï¸");
                enemies.push({ x: currentX + 150, y: platY - 70, width: 70, height: 70, speed: 4 + (money/8000), emoji: pool[Math.floor(Math.random()*pool.length)], startX: currentX + 150, range: platW - 250 });
            }
            currentX += platW;
        }
        lastGeneratedX = currentX;
    }

    function update() {
        if (!gameRunning || isPaused) return;
        if (player.x + 4000 > lastGeneratedX) spawnInfinite(lastGeneratedX, 5000);
        if (player.y > window.innerHeight + 300) endGame();

        let isMoving = keys[39] || keys[68] || keys[37] || keys[65];
        player.state = "idle";

        if (keys[83] || keys[40]) {
            player.state = "defend"; player.velX = 0; player.shield = Math.max(0, player.shield - 0.8);
        } else {
            player.shield = Math.min(100, player.shield + 0.4);
            let speed = (keys[16] && player.stamina > 5) ? 20 : 12;
            if (speed > 12) { player.stamina -= 1.5; player.state = "dash"; } 
            else { player.stamina = Math.min(100, player.stamina + 0.7); if (isMoving) player.state = "walk"; }
            if (keys[39] || keys[68]) { player.velX = speed; player.facing = 1; }
            else if (keys[37] || keys[65]) { player.velX = -speed; player.facing = -1; }
            else { player.velX *= 0.8; }
            if (keys[88]) { 
                player.state = "kick";
                enemies.forEach((en, i) => {
                    let hitX = player.facing === 1 ? player.x + player.width : player.x - 70;
                    if (Math.abs(hitX - en.x) < 100 && Math.abs(player.y - en.y) < 150) { enemies.splice(i, 1); money += 100; }
                });
            }
        }

        if (!player.grounded) player.state = "jump";
        if (player.invincible) player.state = "hurt";
        if ((keys[32] || keys[38] || keys[87]) && player.grounded) { player.velY = -27; player.grounded = false; }

        player.velY += 1.3; player.y += player.velY; player.x += player.velX;
        player.grounded = false;

        platforms.forEach(p => {
            if (player.x + 40 < p.x + p.width && player.x + player.width - 40 > p.x && player.y + player.height > p.y && player.y + player.height < p.y + 60) {
                player.y = p.y - player.height; player.velY = 0; player.grounded = true;
            }
        });

        enemies.forEach((en, i) => {
            en.x += en.speed;
            if (en.x > en.startX + en.range || en.x < en.startX) en.speed *= -1;
            let pX = player.x + 40, pW = player.width - 80;
            if (pX < en.x + en.width && pX + pW > en.x && player.y + player.height > en.y && player.y + player.height < en.y + 45 && player.velY > 0) {
                enemies.splice(i, 1); money += 150; player.velY = -19;
            } else if (Math.abs((player.x + 60) - (en.x + 35)) < 70 && Math.abs((player.y + 90) - (en.y + 35)) < 90) {
                if (!player.invincible && (player.state !== "defend" || player.shield <= 0)) {
                    player.hp -= 20; player.invincible = true;
                    if (player.hp <= 0) endGame();
                    setTimeout(() => player.invincible = false, 800);
                }
            }
        });

        cameraX += (player.x - window.innerWidth/4 - cameraX) * 0.1;
        document.getElementById("hpFill").style.width = player.hp + "%";
        document.getElementById("staminaFill").style.width = player.stamina + "%";
        document.getElementById("moneyText").innerText = money;
    }

    function endGame() {
        gameRunning = false;
        setTimeout(() => {
            let n = prompt(`GAME OVER! Final Score: $${money}\nEnter your name:`);
            if(n) {
                let s = JSON.parse(localStorage.getItem('kaguya_scores')) || [];
                s.push({name: n, score: money});
                s.sort((a,b) => b.score - a.score);
                localStorage.setItem('kaguya_scores', JSON.stringify(s.slice(0,5)));
            }
            location.reload();
        }, 100);
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save(); ctx.translate(-cameraX, 0);
        platforms.forEach(p => { 
            ctx.fillStyle = "#8a401a"; ctx.fillRect(p.x, p.y + 30, p.width, p.height); 
            ctx.fillStyle = "#148523"; ctx.fillRect(p.x, p.y, p.width, 30); 
        });
        enemies.forEach(en => { ctx.font = "60px Arial"; ctx.fillText(en.emoji, en.x, en.y + 55); });
        let img = spr[player.state] || spr.idle;
        ctx.save(); ctx.translate(player.x + player.width/2, player.y + player.height/2); ctx.scale(player.facing, 1);
        ctx.drawImage(img, -player.width/2, -player.height/2, player.width, player.height);
        if (player.state === "defend") { 
            ctx.beginPath(); ctx.arc(0, 0, player.shield * 1.3, 0, Math.PI*2); 
            ctx.fillStyle = player.shield < 25 ? "rgba(255, 50, 50, 0.4)" : "rgba(100, 200, 255, 0.4)"; 
            ctx.fill(); 
        }
        ctx.restore(); ctx.restore();
    }

    function loop() { if (gameRunning) { update(); draw(); requestAnimationFrame(loop); } }
    
    window.addEventListener("keydown", e => { 
        if (e.keyCode === 13 && gameRunning) { 
            isPaused = !isPaused; 
            document.getElementById("pauseOverlay").style.display = isPaused ? "block" : "none";
            document.getElementById("pauseOverlay").style.left = (window.innerWidth/2 - 80) + "px";
            document.getElementById("pauseOverlay").style.top = (window.innerHeight/2 - 30) + "px";
        } 
        keys[e.keyCode] = true; 
    });
    window.addEventListener("keyup", e => keys[e.keyCode] = false);
</script>
</body>
</html>
